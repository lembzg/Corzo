<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Finance Dashboard ¬∑ Sign In</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="login-shell">
    <header class="topbar">
      <div class="user">
        <img src="CorzoLogoEmpty.png" class="logo">
      </div>
      <button class="icon-btn" aria-label="Close" onclick="window.location.href='index.html'">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path>
        </svg>
      </button>
    </header>

    <main class="centered-div">
      <div class="screen active">
        <!-- ‚úÖ ADD FORM WITH ID -->
        <form id="loginForm" class="card-form">
          <div class="form-header">
            <a href="index.html" class="icon-btn" aria-label="Back" style="text-decoration: none">
              ‚Üê
            </a>
          </div>

          <h1 class="form-title" style="font-size: 22px;"><b>Sign In</b></h1>
          <p class="form-sub" style="font-size: 15px;">Enter your credentials to access your account</p>

          <div class="input-stack">
            <div class="field">
              <div>
                <small>Email address</small>
                <!-- ‚úÖ ADD NAME ATTRIBUTE -->
                <input type="email" name="email" placeholder="you@example.com" aria-label="Email address" required>
              </div>
            </div>

            <div class="field">
              <div>
                <small>Password</small>
                <input type="password" name="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" aria-label="Password" required>
              </div>
            </div>
          </div>

          <div class="form-options">
            <label class="checkbox">
              <input type="checkbox" aria-label="Remember me">
              <span>Remember me</span>
            </label>
            <a href="#" class="text-btn" style="font-size: 12px;">Forgot password?</a>
          </div>

          <button type="submit" class="cta-wide" style="font-size: 15px;">Sign In</button>
          
          <p class="text-center">
            Don't have an account? 
            <a href="register.html" class="link" style="font-size: 15px;">Sign up</a>
          </p>
        </form>

        <div class="card" style="margin-top: 20px;">
          <div class="label">Secure Login</div>
          <div class="pill-row">
            <span class="pill">üîê 256-bit encryption</span>
            <span class="pill">üõ°Ô∏è 2FA available</span>
          </div>
          <p class="sub" style="margin-top: 8px;">
            Your security is our priority. All data is encrypted end-to-end.
          </p>
        </div>
      </div>
    </main>
  </div>

  <script type="module">
    import { api } from './api.js';
    
    document.addEventListener('DOMContentLoaded', function() {
        const loginForm = document.getElementById('loginForm');
        const submitBtn = loginForm.querySelector('.cta-wide');
        
        loginForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Show loading state
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Signing in...';
            
            const formData = new FormData(loginForm);
            const credentials = {
                email: formData.get('email'),
                password: formData.get('password')
            };
            
            console.log('Attempting login with:', credentials.email);
            
            try {
                const result = await api.login(credentials);
                
                console.log('Login successful:', result.user.email);
                
                // Store token and user
                localStorage.setItem('token', result.token);
                localStorage.setItem('user', JSON.stringify(result.user));
                if (result.user?.id) {
                    localStorage.setItem('userId', result.user.id);
                }
                
                // Redirect to dashboard with userId in query for immediate context
                const uid = result.user?.id || '';
                const dashUrl = uid ? `main-page.html?userId=${encodeURIComponent(uid)}` : 'main-page.html';
                window.location.replace(dashUrl);
                
            } catch (error) {
                console.error('Login failed:', error.message);
                alert('Login failed: ' + error.message);
                
                // Reset button
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });
    });
  </script>
</body>
</html>
